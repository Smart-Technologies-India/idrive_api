// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  SYSTEM
  ADMIN
  USER
  DRIVER
  MT_ADMIN
  MT_ACCOUNTS
  MT_MANAGER
}

enum Status {
  ACTIVE
  INACTIVE
}

enum DriverStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
  SUSPENDED
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum SalaryStatus {
  PENDING
  PAID
  PROCESSING
}

enum CarStatus {
  AVAILABLE
  IN_USE
  MAINTENANCE
  INACTIVE
}

enum FuelType {
  PETROL
  DIESEL
  ELECTRIC
  HYBRID
  CNG
}

enum TransmissionType {
  MANUAL
  AUTOMATIC
  AMT
  CVT
}

model user {
  id               Int              @id @default(autoincrement())
  name             String
  surname          String?
  fatherName       String?
  contact1         String           @unique
  contact2         String?
  address          String?          @db.LongText
  permanentAddress String?          @db.LongText
  bloodGroup       String?
  role             Role             @default(USER)
  email            String?          @unique
  password         String?
  otp              String?
  dob              DateTime?
  profile          String?
  status           Status           @default(ACTIVE)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  deletedAt        DateTime?
  schoolId         Int?
  school           school?          @relation(fields: [schoolId], references: [id])
  driver           driver?          @relation("UserDriver")
  bookings         booking[]        @relation("BookingCustomer")
  bookingServices  bookingService[] @relation("UserBookingServices")
  payments         payment[]        @relation("PaymentUser")
}

model driver {
  id       Int    @id @default(autoincrement())
  userId   Int    @unique
  schoolId Int
  driverId String @unique

  // Personal Information
  name           String
  email          String?  @unique
  mobile         String   @unique
  alternatePhone String?
  address        String   @db.LongText
  dateOfBirth    DateTime
  bloodGroup     String?
  gender         String

  // License Information
  licenseNumber     String   @unique
  licenseType       String
  licenseIssueDate  DateTime
  licenseExpiryDate DateTime

  // Professional Information
  experience  Int      @default(0)
  joiningDate DateTime @default(now())
  salary      Float    @default(0)

  // Emergency Contact
  emergencyContactName     String?
  emergencyContactNumber   String?
  emergencyContactRelation String?

  // Performance Metrics
  totalBookings     Int   @default(0)
  completedBookings Int   @default(0)
  cancelledBookings Int   @default(0)
  rating            Float @default(0.0)

  // Status
  status DriverStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  user            user             @relation("UserDriver", fields: [userId], references: [id], onDelete: Cascade)
  school          school           @relation(fields: [schoolId], references: [id])
  leaveHistory    leaveHistory[]
  salaryHistory   salaryHistory[]
  assignedCars    car[]            @relation("CarAssignedDriver")
  bookingSessions bookingSession[] @relation("BookingSessionDriver")

  @@index([schoolId])
  @@index([userId])
}

model leaveHistory {
  id       Int    @id @default(autoincrement())
  driverId Int
  leaveId  String @unique

  // Leave Details
  fromDate  DateTime
  toDate    DateTime
  reason    String   @db.Text
  leaveType String? // SICK, CASUAL, ANNUAL, etc.
  totalDays Int

  // Approval Details
  status          LeaveStatus @default(PENDING)
  approvedBy      Int?
  approvedAt      DateTime?
  rejectionReason String?     @db.Text

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  driver driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([driverId])
  @@index([status])
}

model salaryHistory {
  id       Int    @id @default(autoincrement())
  driverId Int
  salaryId String @unique

  // Salary Details
  month       String // Format: "November 2024"
  year        Int
  monthNumber Int // 1-12
  basicSalary Float
  bonus       Float  @default(0)
  deductions  Float  @default(0)
  netSalary   Float

  // Payment Details
  paymentMethod String? // CASH, BANK_TRANSFER, CHEQUE
  transactionId String?
  remarks       String?   @db.Text
  paidBy        Int?
  paidOn        DateTime?

  // Status
  status SalaryStatus @default(PENDING)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  driver driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@unique([driverId, year, monthNumber])
  @@index([driverId])
  @@index([status])
}

enum SchoolStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model school {
  id                 Int     @id @default(autoincrement())
  name               String
  email              String? @unique
  phone              String
  alternatePhone     String?
  address            String  @db.LongText
  registrationNumber String  @unique
  gstNumber          String? @unique
  establishedYear    String
  website            String
  logo               String?

  // Operating Hours
  dayStartTime   String?
  dayEndTime     String?
  lunchStartTime String?
  lunchEndTime   String?
  weeklyHoliday  String?

  // Owner/Contact Person
  ownerName  String?
  ownerPhone String?
  ownerEmail String?

  // Bank Details
  bankName      String?
  accountNumber String?
  ifscCode      String?
  branchName    String?

  // License & Certifications
  rtoLicenseNumber      String?
  rtoLicenseExpiry      DateTime?
  insuranceProvider     String?
  insurancePolicyNumber String?
  insuranceExpiry       DateTime?

  // Social Media
  facebook  String?
  instagram String?
  twitter   String?

  status    SchoolStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  deletedAt DateTime?

  // Relations
  users           user[]
  drivers         driver[]
  cars            car[]
  courses         course[]
  holidays        holiday[]
  bookings        booking[]
  bookingServices bookingService[]
  schoolServices  schoolService[]
}

enum CarCategory {
  SEDAN
  MUV
  SUV
  HATCHBACK
}

enum CarAdminStatus {
  ACTIVE
  INACTIVE
}

model carAdmin {
  id Int @id @default(autoincrement())

  // Basic Information
  name         String
  manufacturer String
  category     CarCategory

  // Status
  status CarAdminStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  cars car[]

  @@index([status])
  @@index([name])
  @@index([category])
}

model car {
  id         Int    @id @default(autoincrement())
  schoolId   Int
  carId      String @unique
  carAdminId Int?

  // Basic Information
  carName            String
  model              String
  registrationNumber String @unique
  year               Int
  color              String

  // Technical Specifications
  fuelType        FuelType
  transmission    TransmissionType
  seatingCapacity Int              @default(5)
  engineNumber    String?          @unique
  chassisNumber   String?          @unique

  // Purchase Information
  purchaseDate   DateTime?
  purchaseCost   Float?
  currentMileage Int       @default(0)

  // Documents & Compliance
  insuranceNumber String?
  insuranceExpiry DateTime?
  pucExpiry       DateTime?
  fitnessExpiry   DateTime?

  // Maintenance
  lastServiceDate DateTime?
  nextServiceDate DateTime?

  // Assignment
  assignedDriverId Int?

  // Performance Metrics
  totalBookings Int @default(0)

  // Status
  status CarStatus @default(AVAILABLE)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  school          school           @relation(fields: [schoolId], references: [id])
  carAdmin        carAdmin?        @relation(fields: [carAdminId], references: [id])
  assignedDriver  driver?          @relation("CarAssignedDriver", fields: [assignedDriverId], references: [id])
  holidays        holiday[]
  bookings        booking[]        @relation("BookingCar")
  bookingSessions bookingSession[] @relation("BookingSessionCar")
  carCourses      carCourse[]      @relation("CarToCourse")

  @@index([schoolId])
  @@index([carAdminId])
  @@index([status])
  @@index([assignedDriverId])
}

model carCourse {
  id        Int       @id @default(autoincrement())
  carId     Int
  courseId  Int
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  car    car    @relation("CarToCourse", fields: [carId], references: [id], onDelete: Cascade)
  course course @relation("CourseToCar", fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([carId, courseId])
  @@index([carId])
  @@index([courseId])
}

enum CourseType {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  REFRESHER
}

enum CourseStatus {
  ACTIVE
  INACTIVE
  UPCOMING
  ARCHIVED
}

model course {
  id       Int    @id @default(autoincrement())
  schoolId Int
  courseId String @unique

  // Basic Information
  courseName String
  courseType CourseType
  minsPerDay Int // Minutes per day (e.g., 30, 60, 90)
  courseDays Int // Number of days
  price      Float

  // Enrollment
  enrolledStudents Int @default(0)

  // Course Details
  description  String  @db.LongText
  syllabus     String? @db.LongText // JSON array of topics
  requirements String? @db.LongText

  // Performance Metrics
  sessionsCompleted Int   @default(0)
  totalRevenue      Float @default(0)

  // Status
  status CourseStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  school        school      @relation(fields: [schoolId], references: [id])
  syllabusItems syllabus[]
  bookings      booking[]
  courseCars    carCourse[] @relation("CourseToCar")

  @@index([schoolId])
  @@index([status])
  @@index([courseType])
}

model syllabus {
  id         Int    @id @default(autoincrement())
  courseId   Int
  syllabusId String @unique

  // Day Information
  dayNumber Int // Day 1, Day 2, etc.

  // Lesson Details
  title  String // e.g., "Introduction to Traffic Rules"
  topics String @db.LongText // JSON array of topics

  // Learning Objectives
  objectives          String? @db.LongText // JSON array of learning objectives
  practicalActivities String? @db.LongText // JSON array of practical activities

  // Assessment
  assessmentCriteria String? @db.LongText // JSON array of assessment criteria

  // Additional Notes
  notes String? @db.LongText

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  course course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, dayNumber])
  @@index([courseId])
  @@index([dayNumber])
}

enum ServiceCategory {
  NEW_LICENSE
  I_HOLD_LICENSE
  TRANSPORT
  IDP
}

enum ServiceStatus {
  ACTIVE
  INACTIVE
  UPCOMING
  DISCONTINUED
}

model service {
  id        Int    @id @default(autoincrement())
  serviceId String @unique

  // Basic Information
  serviceName String
  category    ServiceCategory

  // Pricing & Duration
  duration Int // Duration in days (validity period)

  // Service Details
  description        String  @db.LongText
  features           String? @db.LongText // JSON array or newline-separated
  includedServices   String? @db.LongText // Comma-separated or JSON array
  requirements       String? @db.LongText
  termsAndConditions String? @db.LongText

  // Status
  status ServiceStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  schoolServices schoolService[]

  @@index([status])
}

enum SchoolServiceStatus {
  ACTIVE
  INACTIVE
}

model schoolService {
  id              Int    @id @default(autoincrement())
  schoolId        Int
  serviceId       Int
  schoolServiceId String @unique

  // Pricing
  licensePrice Float // Price for license service
  addonPrice   Float // Price for addon service

  // Status
  status SchoolServiceStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  school          school           @relation(fields: [schoolId], references: [id])
  service         service          @relation(fields: [serviceId], references: [id])
  bookingServices bookingService[]

  @@unique([schoolId, serviceId])
  @@index([schoolId])
  @@index([serviceId])
  @@index([status])
}

enum HolidayDeclarationType {
  ALL_CARS_MULTIPLE_DATES
  ONE_CAR_MULTIPLE_DATES
  ALL_CARS_PARTICULAR_SLOTS
  ONE_CAR_PARTICULAR_SLOTS
}

enum HolidayStatus {
  ACTIVE
  EXPIRED
  UPCOMING
  CANCELLED
}

model holiday {
  id       Int @id @default(autoincrement())
  schoolId Int

  // Declaration Details
  declarationType HolidayDeclarationType
  carId           Int?

  // Date Range
  startDate DateTime
  endDate   DateTime

  // Time Slots (for particular slots types)
  slots String? @db.LongText // JSON array of time slots

  // Reason
  reason String @db.Text

  // Status
  status HolidayStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  school school @relation(fields: [schoolId], references: [id])
  car    car?   @relation(fields: [carId], references: [id])

  @@index([schoolId])
  @@index([carId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum BookingSessionStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum BookingServiceType {
  LICENSE
  ADDON
}

model booking {
  id        Int    @id @default(autoincrement())
  schoolId  Int
  bookingId String @unique

  // Car & Slot Information
  carId       Int
  carName     String
  slot        String
  bookingDate DateTime

  // Customer Information
  customerMobile String
  customerName   String?
  customerEmail  String?
  customerId     Int? // Reference to user table if customer exists

  // Course Information
  courseId    Int // Now references course table
  courseName  String
  coursePrice Float

  // Pricing
  totalAmount Float
  discount    Float?

  // Additional Information
  notes String? @db.LongText

  // Status & Tracking
  status             BookingStatus @default(PENDING)
  confirmationNumber String?

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  school          school           @relation(fields: [schoolId], references: [id])
  customer        user?            @relation("BookingCustomer", fields: [customerId], references: [id])
  car             car              @relation("BookingCar", fields: [carId], references: [id])
  course          course           @relation(fields: [courseId], references: [id])
  sessions        bookingSession[] @relation("BookingSessions")
  bookingServices bookingService[] @relation("BookingServices")
  payments        payment[]        @relation("BookingPayments")

  @@index([schoolId])
  @@index([customerId])
  @@index([bookingDate])
  @@index([status])
  @@index([carId])
  @@index([courseId])
}

model bookingService {
  id              Int  @id @default(autoincrement())
  bookingId       Int? // Optional - for service bookings without car/course
  schoolServiceId Int
  schoolId        Int
  userId          Int

  // Service Details (denormalized for historical reference)
  serviceName        String
  serviceType        BookingServiceType // LICENSE or ADDON
  price              Float
  discount           Float?
  description        String?            @db.LongText
  confirmationNumber String?            @unique

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  booking       booking?      @relation("BookingServices", fields: [bookingId], references: [id], onDelete: Cascade)
  schoolService schoolService @relation(fields: [schoolServiceId], references: [id])
  school        school        @relation(fields: [schoolId], references: [id])
  user          user          @relation("UserBookingServices", fields: [userId], references: [id])

  @@index([bookingId])
  @@index([schoolServiceId])
  @@index([schoolId])
  @@index([userId])
  @@index([confirmationNumber])
}

model bookingSession {
  id        Int @id @default(autoincrement())
  bookingId Int

  // Session Information
  dayNumber   Int // Day 1, Day 2, etc. of the course
  sessionDate DateTime // Scheduled date for this session
  slot        String // Time slot (e.g., "09:00-10:00")

  // Car & Driver Information
  carId    Int
  driverId Int // Assigned driver for this session

  // Session Details
  status      BookingSessionStatus @default(PENDING)
  attended    Boolean              @default(false)
  completedAt DateTime?

  // Session Notes
  instructorNotes  String? @db.LongText
  customerFeedback String? @db.LongText
  internalNotes    String? @db.LongText

  // Performance Tracking
  performanceRating Int? // 1-5 rating
  skillsAssessed    String? @db.LongText // JSON array of skills
  progressNotes     String? @db.LongText

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  booking booking @relation("BookingSessions", fields: [bookingId], references: [id], onDelete: Cascade)
  car     car     @relation("BookingSessionCar", fields: [carId], references: [id])
  driver  driver? @relation("BookingSessionDriver", fields: [driverId], references: [id])

  @@index([bookingId])
  @@index([sessionDate])
  @@index([status])
  @@index([carId])
  @@index([driverId])
  @@index([dayNumber])
}

model payment {
  id        Int   @id @default(autoincrement())
  bookingId Int
  userId    Int
  amount    Float

  // Payment tracking
  paymentNumber String   @unique // Unique identifier for this payment
  paymentDate   DateTime @default(now())
  paymentMethod String? // CASH, CARD, UPI, BANK_TRANSFER, etc.
  transactionId String? // Bank/UPI transaction ID

  // Installment tracking
  installmentNumber Int // 1, 2, 3, etc.
  totalInstallments Int // Total planned installments for this booking

  // Notes and status
  notes  String?       @db.LongText
  status PaymentStatus @default(COMPLETED)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  booking booking @relation("BookingPayments", fields: [bookingId], references: [id], onDelete: Cascade)
  user    user    @relation("PaymentUser", fields: [userId], references: [id])

  @@index([bookingId])
  @@index([userId])
  @@index([paymentDate])
  @@index([status])
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}
